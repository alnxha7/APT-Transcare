{% extends "base.html" %}
{% load static %}
{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorry Receipt</title>

    <link href="{% static 'css/font-face.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-4.7/css/font-awesome.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-5/css/fontawesome-all.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/mdi-font/css/material-design-iconic-font.min.css' %}" rel="stylesheet" media="all">

    <!-- Bootstrap CSS-->
    <link href="{% static 'vendor/bootstrap-4.1/bootstrap.min.css' %}" rel="stylesheet" media="all">

    <!-- Vendor CSS-->
    <link href="{% static 'vendor/animsition/animsition.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css' %}" rel="stylesheet"
          media="all">
    <link href="{% static 'vendor/wow/animate.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/css-hamburgers/hamburgers.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/slick/slick.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/select2/select2.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet" media="all">

    <!-- Main CSS-->
    <link href="{% static 'css/theme.css' %}" rel="stylesheet" media="all">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    @media print {
        body {
            width: 210mm;
            height: 297mm;
            margin: 0;
            padding: 0;
        }
        table {
            width: 100%;
        }
        #print-button {
            display: none;
        }
    }
        .form-control {
        padding: 0px 8px;
        font-size: 14px;
    }
    .mb-3, .mb-2 {
        margin-bottom: 8px !important;
        align-items: center;
    }
     body {
            font-family: Public Sans, sans-serif;
            background-color: #f4f4f4;

            margin: 0;
            padding: 0;
            font-size: 14px;
            align-items: center;
            color:black;
            overflow-x: hidden;

        }
         .logo p {
        color:white;
        }
        .container_box {
            background-color:#FEF3E2;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 2px solid rgb(43, 114, 227);
            margin-left:20px;
            margin-top: 25px;
        }


        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            padding-top: 7px;
            margin-bottom: 5px;
        }

        
        input, select {
            width: 100%;
            font-size: 10px;
        }
        select {
        background:white;
        

        }
        table {
            background:white;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom:20px;
        }
        .table_input{
            border:none;
        }
        th {
            border: 1px solid black;
            background:#f2f2f2;
            padding:0px;
            text-align: center;
            font-size: 12px;
        }
        button {
            padding: 10px;
            background: #28a745;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #218838;
        }
        .btn {
            margin-top: -10px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:20px;
        }

        .btn-info{
            margin-top: -25px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:-15px; 
        }

        .save-btn { background-color: #28a745; }
        .back-btn { background-color: #007bff; }

        .input-right {
            text-align: right;
        }
    @media only screen and (max-width: 600px) {
  .container_box  {
    width: 90%;
  }
}
    label {
        font-weight: 500;
        width: 90px;
        font-size: 12px;
    }
    .form-group-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .form-group-row label {
        min-width: 120px;
        margin-right: 8px;
        margin-bottom: 0;
    }
    /* .table-container {
            margin-top: 20px;
            overflow-x: auto;
        } */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th {
            border: 1px solid #999;
            padding: 0px;
            text-align: center;
        }
        td {
            border: 1px solid #999;
            padding: -4px;
            text-align: center;
            font-size: 11px;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"], input[type="number"] {
            /* width: 100%; */
            padding: -5px;
            box-sizing: border-box;
        }
        .btn-delete {
            color: white;
            border: none;
            padding: 0px 5px;
            cursor: pointer;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .table_data {
            font-size: 12px;
            padding: 2px 4px;
            text-align: center;
            width: 70px; /* set a fixed width */
            max-width: 80px; /* prevent stretching */
            box-sizing: border-box;
        }
.top-section {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 25px;
}

/* Column styling */
.column {
    flex: 1;
    min-width: 300px;
}

.column h4 {
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 10px;
    text-decoration: underline;
}

/* Single field row */
.form-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    width: 100%;
    gap: 8px;
}

.form-row label {
    flex: 0 0 68px;
    text-align: left;
    font-size: 13px;
    margin: 0;
    white-space: nowrap;
}

.form-row input,
.form-row select {
    flex: 1;
    padding: 2px 3px;
    font-size: 13px;
    border: 1px solid #ccc;
}

/* Double fields (2 per row) */
.form-row.double {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.field-pair {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 6px;
}

.field-pair label {
    flex: 0 0 3px;
    text-align: left;
    font-size: 13px;
}

.field-pair input,
.field-pair select {
    flex: 1.5;
}

/* Bottom OK button */
.bottom-buttons {
    width: 100%;
    text-align: center;
    margin-top: 12px;
}

.bottom-buttons button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 14px;
    font-size: 13px;
    border-radius: 4px;
    cursor: pointer;
}

.bottom-buttons button:hover {
    background-color: #0056b3;
}

/* Responsive */
@media (max-width: 992px) {
    .top-section {
        flex-direction: column;
    }
}

.form-group {
    margin: 0px;
}

.bottom-section {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    align-items: stretch;
}

.bottom-box {
    flex: 1;
    min-width: 230px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #fafafa;
}

.box-title {
    font-weight: 600;
    font-size: 13px;
    text-align: center;
    border-bottom: 1px solid #ccc;
    margin-bottom: 10px;
    padding-bottom: 4px;
}

.row-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.row-item label {
    width: 120px;
    font-size: 12px;
}

.row-item input {
    height: 25px;
    font-size: 12px;
}

.row-item.right {
    justify-content: flex-end;
}

.row-item.right label {
    text-align: right;
}

.totals-box {
    background: #ffa10d42;
}

.grand-total {
    background: #1e7e34;
    color: #000000;
    font-weight: bold;
}


/* Widths to control layout */
/* .first-column {
    flex: 1; 
} */

.second-column {
    flex: 0.5; /* Center - less space */
    text-align: left;
}

.third-column {
    padding-left: 10px;
}

/* Optional: Ensure inputs are consistent */
.column input {
    width: 100%;
    font-size: 12px;
    margin-bottom: 0px;
}

/* Make labels a little smaller for alignment */
.column label {
    display: block;
    margin-bottom: 0px;
    font-size: 13px;
}
.d-flex.align-items-center {
    gap: 4px; /* Reduce space between label and input */
}

.d-flex.align-items-center > div {
    margin-bottom: 0;
    flex: 0 0 auto; /* Prevent stretching */
    padding-right: 4px; /* Small spacing */
}

.d-flex.align-items-center label {
    margin-bottom: 0;
    font-size: 12px; /* Optional: reduce font size */
    white-space: nowrap; /* Keep label on one line */
}

.d-flex.align-items-center input {
    flex: 1; /* Let input take remaining space */
    max-width: 150px; 
    font-size: 13px;
}
 </style>

<!-- /* --------------------------- INVOICE STYLE ----------------------------- */ -->

<style>
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    /* -webkit-print-color-adjust: exact; */
}

/* Full A4 canvas */
.page {
    position: relative;
    width: 210mm;
    height: 297mm;
}

/* Generic quadrant */
.quadrant {
    position: absolute;
    width: 105mm;
    height: 148.5mm;
    box-sizing: border-box;
    overflow: hidden;
    padding: 6mm;
}

/* Positioning */
.top-left {
    top: 0;
    left: 0;
}

/* (Optional other quadrants)
.top-right { top: 0; left: 105mm; }
.bottom-left { top: 148.5mm; left: 0; }
.bottom-right { top: 148.5mm; left: 105mm; }
*/

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    border: 1px solid black;
    padding: 3px;
    font-size: 9px;
}
</style>

<!-- /* --------------------------- INVOICE STYLE END ----------------------------- */ -->

 <div class="container_box">

 <div class="container">


<h2>Cash Receipt</h2>

<form method="post" id="bill-form">
    {% csrf_token %}
    <div class="container">
        <div class="top-section">
    <!-- 1?? Consigner Column -->
    <div class="column">
        <!-- Row 1: Series + Bill No -->
        <div class="form-row double" style="width: 154%;">
            <div class="field-pair">
                <label>Series</label>
                <select name="series" id="series" class="form-control" required style="padding: 3px 4px; font-size: 13px; height: 30px;">
                    <option value="">Select Series</option>
                    {% for voucher in vouchers %}
                        <option value="{{ voucher.id }}" {% if lr.series.id == voucher.id %} selected {% endif %}>{{ voucher.series }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="field-pair">
                <label>Receipt No</label>
                <input type="text" name="entry_number" id="entry_number" class="form-control" value="{{ lr.receipt_no }}" readonly required>
            </div>
            <div class="field-pair">
            <label>Date</label>
            <input type="date" id="bill_date" name="bill_date" 
            class="form-control" value="{% if lr.lr_date %}{{ lr.lr_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}" required>
        </div>
        </div>

        <!-- Row 2: Code + Name -->
        <div class="form-row double" style="width: 171%;">
            <div class="field-pair" style="max-width: 190px;">
                <label>Code</label>
                <input type="text" style="max-width: 50% !important;" id="consigner_code" name="consigner_code" class="form-control" value="{{ lr.consigner_code }}" readonly required>
            </div>
            <div class="field-pair" style="max-width: 335px; display: flex; align-items: center;">
                <label style="margin-right: 8px; white-space: nowrap;">Consigner Name</label>
                <input type="text" id="consigner_name" name="consigner_name" class="form-control" value="{{ lr.consigner_name }}" autocomplete="off" required>
            </div>
        </div>

        <!-- Row 3-5: Address 1-3 -->
        <div class="form-row"><label>Address 1</label><input type="text" id="consigner_address1" name="consigner_address1" class="form-control" value="{{ lr.consigner_account.address1 }}"></div>
        <div class="form-row"><label>Address 2</label><input type="text" id="consigner_address2" name="consigner_address2" class="form-control" value="{{ lr.consigner_account.address2 }}"></div>
        <div class="form-row"><label>Address 3</label><input type="text" id="consigner_address3" name="consigner_address3" class="form-control" value="{{ lr.consigner_account.address3 }}"></div>
        <div class="form-row"><label>GST No</label><input type="text" id="consigner_gstno" name="consigner_gstno" class="form-control" value="{{ lr.consigner_account.gstno }}"></div>
        <div class="form-row"><label>Phone</label><input type="text" id="consigner_phone" name="consigner_phone" class="form-control" value="{{ lr.consigner_account.mobile }}"></div>
    </div>

    <!-- 2?? Middle Column -->
    <div class="column" style="position: relative; top: 75px;">
        <div class="form-row">
            <label>Payment</label>
            <select id="payment_method" name="payment_method">
                <option value="PAID" {% if lr.payment == "PAID" %} selected {% endif %}>PAID</option>
                <option value="TO_PAY" {% if lr.payment == "TO_PAY" %} selected {% endif %}>TO PAY</option>
                <option value="CREDIT" {% if lr.payment == "CREDIT" %} selected {% endif %}>CREDIT</option>
            </select>
        </div>
        
        <div class="form-row">
            <label>Remarks</label>
            <input type="text" class="form-control" id="remarks" name="remarks" value="{{ lr.remarks }}">
        </div>

        <div class="form-row">
            <label>Executive</label>
            <select name="employee" id="employee">
                {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if lr.employee and lr.employee.id == emp.id %} selected {% endif %}>{{ emp.employee_name }}</option>
                {% endfor %}
            </select>
        </div>
        <input type="hidden" name="ajax_rate" step="0.01" id="ajax_rate">
    </div>

    <!-- 3?? Consignee Column -->
    <div class="column">
        <!-- Row 1: Code + Name -->
        <div class="form-row double" style="transform: translateX(-170px); width: 154%;">
            <div class="field-pair" style="max-width: 170px;">
                <label>Code</label>
                <input type="text" style="max-width: 50% !important;" id="consignee_code" name="consignee_code" value="{{ lr.consignee_code }}" class="form-control" readonly required>
            </div>
            <div class="field-pair" style="max-width: 300px; display: flex; align-items: center;">
                <label style="margin-right: 8px; white-space: nowrap;">Consignee Name</label>
                <input type="text" id="consignee_name" name="consignee_name" class="form-control" value="{{ lr.consignee_name }}" required>
            </div>
        </div>

        <!-- Row 2-4: Address 1-3 -->
        <div class="form-row"><label>Address 1</label><input type="text" name="consignee_address1" id="consignee_address1" class="form-control" value="{{ lr.consignee_account.address1 }}"></div>
        <div class="form-row"><label>Address 2</label><input type="text" name="consignee_address2" id="consignee_address2" class="form-control" value="{{ lr.consignee_account.address2 }}"></div>
        <div class="form-row"><label>Address 3</label><input type="text" name="consignee_address3" id="consignee_address3" class="form-control" value="{{ lr.consignee_account.address3 }}"></div>
        <div class="form-row"><label>GST No</label><input type="text" name="consignee_gstno" id="consignee_gstno" class="form-control" value="{{ lr.consignee_account.gstno }}"></div>
        <div class="form-row"><label>Phone</label><input type="text" name="consignee_phone" id="consignee_phone" class="form-control" value="{% if lr.consignee_phone %}{{ lr.consignee_phone }}{% else %}{{ lr.consignee_account.mobile }}{% endif %}"></div>
        </div>
    </div>
</div>

        <!-- ?? Table Section -->
<div class="table-container">
        <table id="tripTable" border="1" style="width:100%; border-collapse:collapse; text-align:center;">
            <thead>
                <tr>
                    <th>Sl.no</th>
                    <th style="width: 6%;">Item Code</th>
                    <th style="width: 25%;">Commodity/Item</th>
                    <th>Inv No</th>
                    <th>Inv Amt</th>
                    <th>Actual Weight</th>
                    <th>Charged Weight</th>
                    <th>Nos</th>
                    <th>Rate</th>
                    <th>Freight</th>
                    <th>Pkg</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% if lr_items %}
                    {% for item in lr_items %}
                    <tr>
                        <td class="slno">{{ forloop.counter }}</td>
                        <td><input type="text" name="item_code[]" class="item_code form-control" value="{{ item.item_code }}"></td>
                        <td><input type="text" name="commodity[]" class="commodity form-control" value="{{ item.item }}"></td>
                        <td><input type="text" name="inv_no[]" class="inv_no form-control" value="{{ item.inv_no }}"></td>
                        <td><input type="number" name="inv_amount[]" class="inv_amount form-control" value="{{ item.inv_amount }}"></td>
                        <td><input type="number" name="weight[]" class="weight form-control" value="{{ item.weight }}"></td>
                        <td><input type="number" name="charged_weight[]" class="charged_weight form-control" value="{{ item.charged_weight }}"></td>
                        <td><input type="number" name="numbers[]" class="numbers form-control" value="{{ item.numbers }}"></td>
                        <td><input type="number" name="rate[]" class="rate form-control" step="0.01" value="{{ item.rate }}"></td>
                        <td><input type="number" name="freight[]" class="freight form-control" value="{{ item.freight }}"></td>
                        <td><input type="text" name="pkg[]" class="pkg form-control" value="{{ item.pkg }}"></td>
                        <td><span class="delete-row" style="cursor:pointer; color:red;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="12" width="12" viewBox="0 0 640 640">
                                <path fill="#ff0000" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                            </svg>
                        </span></td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td class="slno">1</td>
                        <td><input type="text" name="item_code[]" class="item_code form-control"></td>
                        <td><input type="text" name="commodity[]" class="commodity form-control"></td>
                        <td><input type="text" name="inv_no[]" class="inv_no form-control"></td>
                        <td><input type="number" name="inv_amount[]" class="inv_amount form-control"></td>
                        <td><input type="number" name="weight[]" class="weight form-control"></td>
                        <td><input type="number" name="charged_weight[]" class="charged_weight form-control"></td>
                        <td><input type="number" name="numbers[]" class="numbers form-control"></td>
                        <td><input type="number" name="rate[]" step="0.01" class="rate form-control"></td>
                        <td><input type="number" name="freight[]" class="freight form-control"></td>
                        <td><input type="text" name="pkg[]" class="pkg form-control"></td>
                        <td><span class="delete-row" style="cursor:pointer; color:red;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="12" width="12" viewBox="0 0 640 640">
                                <path fill="#ff0000" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                            </svg>
                        </span></td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

        <!-- ?? Expense Details Section -->
        <div class="row mt-4"></div>

<!-- ================= BOTTOM SECTION ================= -->
<div class="bottom-section">

  <!-- LOAD DETAILS -->
  <div class="bottom-box" style="height: 20vh;">
    <div class="box-title">Load Details</div>

    <div class="row-item">
      <label>Load From</label>
      <input type="text" name="load_from" id="load_from"
             class="form-control"
             value="{{ lr.load_from }}"
             required>
    </div>

    <div class="row-item">
      <label>Load To</label>
      <input type="text" name="load_to" id="load_to"
             class="form-control"
             value="{{ lr.load_to }}"
             required>
    </div>
  </div>

  <!-- EDITABLE CHARGES -->
  <div class="bottom-box">
    <div class="box-title">Booking Charges</div>

    <div class="row-item">
      <label>Hamali</label>
      <input type="number" name="hamali" id="hamali"
             class="form-control"
             value="{{ lr.hamali|default:'0.00' }}" step="0.01" readonly>
    </div>

    <div class="row-item">
      <label>Door CL / DL</label>
      <input type="number" name="door_cl" id="door_cl"
             class="form-control"
             value="{{ lr.door_cl_dl|default:'0.00' }}" step="0.01" readonly>
    </div>

    <div class="row-item">
      <label>Risk Charge</label>
      <input type="number" name="risk_charge" id="risk_charge"
             class="form-control"
             value="{{ lr.risk_charge|default:'0.00' }}" step="0.01" readonly>
    </div>

    <div class="row-item">
      <label>Statutory</label>
      <input type="number" name="statutory" id="statutory"
             class="form-control"
             value="{{ lr.statutory_charge|default:'0.00' }}" step="0.01" readonly>
    </div>
  </div>

  <!-- CHARGES SUMMARY -->
  <div class="bottom-box">
    <div class="box-title">Delivery Charges</div>

    <div class="row-item">
      <label>Hamali</label>
      <input type="number" id="cr_hamali" name="cr_hamali" value="{{ lr.cr_hamali|default:'0.00' }}" class="form-control">
    </div>

    <div class="row-item">
      <label>Door CL / DL</label>
      <input type="number" id="cr_door_cl" name="cr_door_cl_dl" value="{{ lr.cr_door_cl_dl|default:'0.00' }}" class="form-control">
    </div>

    <div class="row-item">
      <label>Risk Charge</label>
      <input type="number" id="cr_risk_charge" name="cr_risk_charge" value="{{ lr.cr_risk_charge|default:'0.00' }}" class="form-control">
    </div>

    <div class="row-item">
      <label>Statutory</label>
      <input type="number" id="cr_statutory" name="cr_statutory_charge" value="{{ lr.cr_statutory_charge|default:'0.00' }}" class="form-control">
    </div>
  </div>

  <!-- TOTALS -->
  <div class="bottom-box totals-box">
    <div class="box-title">Totals</div>

    <div class="row-item right">
      <label>Gross Amount</label>
      <input type="number" id="gross_amount" value="{{ lr.gross_amount|default:'0.00' }}"
             class="form-control" name="gross_amount" readonly>
    </div>

    <div class="row-item right">
      <label>Total Charges</label>
      <input type="number" id="total_charges" value="{{ lr.total_charges|default:'0.00' }}"
             class="form-control" name="total_charges" readonly>
    </div>

    <div class="row-item right">
      <label>Grand Total</label>
      <input type="number" id="grand_total" value="{{ lr.grand_total|default:'0.00' }}" name="grand_total"
             class="form-control grand-total" style="background-color: green; color: #ffffff;" readonly>
    </div>
  </div>

</div>
<!-- ================= END BOTTOM SECTION ================= -->



<!-- ?? Buttons Section -->
<div class="text-end" style="margin-top:0px;">
{% if request.GET.action == 'delete' %}
    <a href="{% url 'main:index' %}" class="btn btn-primary btn-sm">Cancel</a>
    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
{% else %} 
  <a href="{% url 'main:index' %}" class="btn btn-danger btn-sm">Cancel</a>
  <button type="submit" class="btn btn-primary btn-sm print-button" name="action" value="print">Print</button>
  <button type="submit" class="btn btn-success btn-sm" name="action" value="save">Save</button>
{% endif %}
</div>
</form>


</div>
</div>







<!-- --------------------------------------------------- INVOICE ----------------------------------------------------->

<div id="print-header" 
     style="display:none; width:100%; padding:10px 30px; box-sizing:border-box; background:white;">

     <div class="invoice-content">
<!-- ===================== HEADER START ===================== -->

<div style="display:flex; width:100%; align-items:center; padding:10px 20px; box-sizing:border-box;">

    <!-- LEFT : LOGO -->
    <div style="flex:1;">
        <img src="{% static 'images/icon/apt_logo.png' %}" 
             alt="Company Logo"
             style="width:80px; height:auto;">
    </div>

    <!-- CENTER : COMPANY DETAILS -->
    <div style="flex:3; text-align:center; line-height:1.4;">

        <!-- Company Name -->
        <div style="font-size:14px; font-weight:800; text-transform:uppercase;">
            {{ lr.company.companyname }}
        </div>

        <!-- Company Address -->
        <div style="font-size:7px; margin-top:6px;">
            {{ lr.company.address1 }}<br>
            {{ lr.company.address2 }} {{ lr.company.address3 }}
        </div>

        <!-- Phone Numbers -->
        <div style="font-size:7px; margin-top:4px;">
            Phone: {{ lr.company.phoneno }}  
            &nbsp; | &nbsp;  
            Mobile: {{ lr.company.mobile }}
        </div>

        <!-- GST Number -->
        <div style="font-size:8px; margin-top:4px; font-weight:600;">
            GST No: {{ lr.company.gst }}
        </div>

    </div>

    <!-- RIGHT : EMPTY / FUTURE USE -->
    <div style="flex:1;"></div>

</div>
<!-- ======= CASH RECEIPT HEADING ======= -->
<div style="text-align:center; margin-top:5px; margin-bottom:10px;">
    <span style="font-size:13px; font-weight:700; text-decoration:underline;">
        CASH RECEIPT
    </span>
</div>
<!-- ===================== HEADER END ===================== -->

<!-- ===================== DETAILS SECTION ===================== -->

<div style="display:flex; width:100%; gap:20px; margin-top:10px; font-size:10px;">

    <!-- LEFT COLUMN -->
    <div style="flex:1; line-height:1.8;">

        <div><strong>CR No:</strong> {{ lr.series.series }}{{ lr.receipt_no }}</div>
        <div><strong>CR Date:</strong> {{ lr.receipt_date }}</div>
        <div><strong>LR No:</strong> {{ lr.lr.series.series }}{{ lr.lr.lr_no }}</div>
        <div><strong>LR Date:</strong> {{ lr.lr.lr_date }}</div>
        <div><strong>Consignor:</strong> {{ lr.consigner_name }}</div>
        
    </div>
    
    <!-- RIGHT COLUMN -->
    <div style="flex:1; line-height:1.8;">
        
        <div><strong>From:</strong> {{ lr.load_from }}</div>
        <div><strong>To:</strong> {{ lr.load_to }}</div>
        <div><strong>Payment Mode:</strong> {{ lr.payment }}</div>
        <div><strong>Branch:</strong> {{ lr.branch.branch_name }}</div>
        <div><strong>Consignee:</strong> {{ lr.consignee_name }}</div>

    </div>

</div>

 <!-- ===================== ITEM TABLE ====================== -->

<table border="1" style="width:100%; border-collapse:collapse; margin-top:10px; font-size:7px; text-align:center;">
    <thead>
        <tr style="font-weight:600; background:#f2f2f2;">
            <th style="width:5%;">Sl.No</th>
            <th style="width:12%;">No: Articles</th>
            <th style="width:12%;">Act Wt</th>
            <th style="width:12%;">Ch Wt</th>
            <th style="width:12%;">Freight</th>
        </tr>
    </thead>

    <tbody>
        {% if lr_items %}
            {% for item in lr_items %}
            <tr>
                <td>{{ forloop.counter }}</td>

                <!-- Item (Commodity) -->
                <td>
                    {{ item.numbers }}
                </td>

                <!-- Weight -->
                <td>{{ item.weight }}</td>

                <!-- charged_weight -->
                <td>{{ item.charged_weight }}</td>

                <!-- Freight -->
                <td>{{ item.freight }}</td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td>1</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        {% endif %}
    </tbody>
</table>

<!-- ===================== CHARGES SECTION ===================== -->

<div style="display:flex; width:100%; margin-top:12px; gap:40px; font-size:9px;">

    <!-- LEFT COLUMN: INDIVIDUAL CHARGES -->
    <div style="flex:1; line-height:1.8;">

        <div style="display:flex; justify-content:space-between;">
            <span>Hamali</span>
            <span>{{ lr.cr_hamali|default:'0.00' }}</span>
        </div>

        <div style="display:flex; justify-content:space-between;">
            <span>Door CL/DL</span>
            <span>{{ lr.cr_door_cl_dl|default:'0.00' }}</span>
        </div>

        <div style="display:flex; justify-content:space-between;">
            <span>Risk Charge</span>
            <span>{{ lr.cr_risk_charge|default:'0.00' }}</span>
        </div>

        <div style="display:flex; justify-content:space-between;">
            <span>Statutory Charge</span>
            <span>{{ lr.cr_statutory_charge|default:'0.00' }}</span>
        </div>

    </div>

    <!-- RIGHT COLUMN: TOTALS -->
    <div style="flex:1; line-height:1.8;">

        <div style="display:flex; justify-content:space-between;">
            <strong>Gross Amount</strong>
            <strong>{{ lr.gross_amount|default:'0.00' }}</strong>
        </div>

        <div style="display:flex; justify-content:space-between;">
            <strong>Total Charges</strong>
            <strong>{{ lr.total_charges|default:'0.00' }}</strong>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:6px;">
            <span style="font-weight:bold; font-size:11px;">Grand Total</span>
            <span style="font-weight:bold; font-size:11px; color:green;">
                {{ lr.grand_total|default:'0.00' }}
            </span>
        </div>

    </div>

</div>
</div>
</div>


<!-- --------------------------------------------------- INVOICE END ----------------------------------------------------- -->








<script src="{% static 'vendor/jquery-3.2.1.min.js' %}"></script>
<!-- Then jQuery UI -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<!-- Then jQuery UI -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<!-- Bootstrap JS-->
<script src="{% static 'vendor/bootstrap-4.1/popper.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-4.1/bootstrap.min.js' %}"></script>
<!-- Vendor JS       -->
<script src="{% static 'vendor/slick/slick.min.js' %}">
</script>
<script src="{% static 'vendor/wow/wow.min.js' %}"></script>
<script src="{% static 'vendor/animsition/animsition.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar.min.js' %}">
</script>
<script src="{% static 'vendor/counter-up/jquery.waypoints.min.js' %}"></script>
<script src="{% static 'vendor/counter-up/jquery.counterup.min.js' %}">
</script>
<script src="{% static 'vendor/circle-progress/circle-progress.min.js' %}"></script>
<script src="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.js' %}"></script>
<script src="{% static 'vendor/chartjs/Chart.bundle.min.js' %}"></script>
<script src="{% static 'vendor/select2/select2.min.js' %}">
</script>

<!-- Main JS-->
<script src="{% static 'js/main.js' %}"></script>

{% if print %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Cash Receipt Saved Successfully',
        confirmButtonText: 'Print Invoice'
    }).then((result) => {
        if (result.isConfirmed) {
            printInvoice();  
            window.location.href = "{% url 'main:cash_receipt_search' %}"
        }
        else {
            window.location.href = "{% url 'main:cash_receipt_search' %}"
        }
    });
</script>
{% elif success and lr.id %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Cash Receipt Saved Successfully',
        confirmButtonText: 'OK',
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'main:cash_receipt_search' %}"
        }
        else {
            window.location.href = "{% url 'main:cash_receipt_search' %}"
        }
    });
</script>
{% elif success %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Cash Receipt Saved Successfully',
        confirmButtonText: 'OK',
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'main:cash_receipt_search' %}"
        }
        else {
            window.location.href = "{% url 'main:cash_receipt_search' %}"
        }
    });
</script>
{% elif error %}
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Error Saving the Cash Receipt....Please Try Again.....!!! {{error|escapejs}}',
        confirmButtonText: 'OK'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'main:cash_receipt_search' %}"
        }
    });
</script>
{% endif %}
<script>
    document.getElementById('series').addEventListener('change', function () {
        const seriesId = this.value;
        if (seriesId) {
            fetch(`/get_serial_number_cr/?series_id=${seriesId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.serial_no !== undefined) {
                        $('input[name="entry_number"]').val(data.serial_no);
                    } else {
                        document.getElementById('entry_number').value = '';
                    }
                })
                .catch(error => {
                    console.error('Error fetching serial number:', error);
                    document.getElementById('entry_number').value = '';
                });
        } else {
            document.getElementById('entry_number').value = '';
        }
    });
</script>
<script>
    $(document).ready(function() {
        $('#consigner_name, #consignee_name').select2({
            allowClear: true,
            width: 'style'
        });
    });
</script>
<script>
function setupAutocomplete(prefix) {
    $(`#${prefix}_name`).autocomplete({
        source: '/ajax/autocomplete-customers/', 
        minLength: 1,
        select: function(event, ui) {
            $(`#${prefix}_name`).val(ui.item.value);
            $(`#${prefix}_address1`).val(ui.item.address || '');
            $(`#${prefix}_address2`).val(ui.item.address2 || '');
            $(`#${prefix}_address3`).val(ui.item.address3 || '');
            $(`#${prefix}_gstno`).val(ui.item.gstno || '');
            $(`#${prefix}_phone`).val(ui.item.mobile || '');
            $(`#${prefix}_code`).val(ui.item.account_code || '');
            return false;
        }
    });
}

$(document).ready(function() {
    setupAutocomplete("consigner");
    setupAutocomplete("consignee");
});
</script>

<script>
function updateTotals() {
    let freight_total = 0;

    // Calculate total freight from table
    $("#tripTable tbody tr").each(function() {
        const freight = parseFloat($(this).find(".freight").val()) || 0;
        freight_total += freight;
    });

    // Set Gross Amount (only freight)
    $("#gross_amount").val(freight_total.toFixed(2));

    // Get additional charges
    let hamali = parseFloat($("#hamali").val()) || 0;
    let door_cl = parseFloat($("#door_cl").val()) || 0;
    let risk_charge = parseFloat($("#risk_charge").val()) || 0;
    let statutory = parseFloat($("#statutory").val()) || 0;
    let cr_hamali = parseFloat($("#cr_hamali").val()) || 0;
    let cr_door_cl = parseFloat($("#cr_door_cl").val()) || 0;
    let cr_risk_charge = parseFloat($("#cr_risk_charge").val()) || 0;
    let cr_statutory = parseFloat($("#cr_statutory").val()) || 0;

    // Total Charges = Freight + Extra charges
    let total_charges = freight_total + hamali + door_cl + risk_charge + statutory +
                        cr_hamali + cr_door_cl + cr_risk_charge + cr_statutory;

    // Grand Total (same for now)
    let grand_total = total_charges;

    $("#total_charges").val(total_charges.toFixed(2));
    $("#grand_total").val(grand_total.toFixed(2));
}

$(document).on("input", ".freight", function () {
    if (this.value < 0) this.value = 0;
    updateTotals();
});


$(document).on("input", "#hamali, #door_cl, #risk_charge, #statutory, #cr_hamali, #cr_door_cl, #cr_risk_charge, #cr_statutory", function () {
    updateTotals();
});
$(document).ready(function() {

    // ?? Function to calculate total freight and update totals

    // ?? Function to add new row
    function addNewRow() {
    const table = $("#tripTable tbody");
    const rowCount = table.find("tr").length + 1;

    const newRow = `
        <tr>
            <td class="slno">${rowCount}</td>
            <td><input type="text" name="item_code[]" class="item_code form-control"></td>
            <td><input type="text" name="commodity[]" class="commodity form-control"></td>
            <td><input type="text" name="inv_no[]" class="inv_no form-control"></td>
            <td><input type="number" name="inv_amount[]" class="inv_amount form-control"></td>
            <td><input type="number" name="weight[]" class="weight form-control"></td>
            <td><input type="number" name="charged_weight[]" class="charged_weight form-control"></td>
            <td><input type="number" name="numbers[]" class="numbers form-control"></td>

            <!-- ?? auto-apply rate when creating row -->
            <td><input type="number" name="rate[]" class="rate form-control"></td>

            <td><input type="number" name="freight[]" class="freight form-control"></td>
            <td><input type="text" name="pkg[]" class="pkg form-control"></td>
            <td><span class="delete-row" style="cursor:pointer; color:red;">
                <svg xmlns="http://www.w3.org/2000/svg" height="12" width="12" viewBox="0 0 640 640">
                    <path fill="#ff0000" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                </svg>
            </span></td>
        </tr>`;

    table.append(newRow);
    updateSerialNumbers();;
    updateTotals();
}


    // ?? Update serial numbers after add/remove
    function updateSerialNumbers() {
        $("#tripTable tbody tr").each(function(index) {
            $(this).find(".slno").text(index + 1);
        });
    }

    // ?? Delete a row
    $(document).on("click", ".delete-row", function() {
        const rowCount = $("#tripTable tbody tr").length;
        if (rowCount <= 1) {
            Swal.fire({
                icon: "warning",
                title: "At least one row must remain!",
                confirmButtonColor: "#d33",
                confirmButtonText: "OK"
            });
            return;
        }
        $(this).closest("tr").remove();
        updateSerialNumbers();
        updateTotals(); // ?? Update totals after deleting a row
    });

    // ?? Add row on Enter key in rate/freight fields
    $(document).on("keydown", ".rate, .freight", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            addNewRow();
        }
    });

    // ?? Add new row on table double-click
    $("#tripTable").on("dblclick", function() {
        addNewRow();
    });

});
</script>

<script>
$(document).on('input', '.item_code, .commodity', function() {
    let input = $(this);
    let query = input.val().trim();
    let row = input.closest('tr');

    $('.suggestion-box').remove();
    if (query.length < 1) return; 
    $.ajax({
        url: '/ajax/item-search/',
        data: { q: query },
        dataType: 'json',
        success: function(data) {
            $('.suggestion-box').remove();

            if (data.length === 0) return;
            let suggestionBox = $('<div class="suggestion-box"></div>');
            suggestionBox.css({
                position: 'absolute',
                background: '#fff',
                border: '1px solid #ccc',
                'z-index': 1000,
                'max-height': '150px',
                'overflow-y': 'auto',
                width: input.outerWidth()
            });

            $.each(data, function(i, item) {
                let option = $('<div class="suggestion-item"></div>').text(item.name);
                option.css({ padding: '0px', cursor: 'pointer', fontSize: '12px', borderBottom: '1px solid #7b7878' });

                option.on('click', function() {
                    row.find('.commodity').val(item.name);
                    row.find('.item_code').val(item.item_code);
                    $('.suggestion-box').remove();
                });

                suggestionBox.append(option);
            });

            $('body').append(suggestionBox);

            let offset = input.offset();
            suggestionBox.css({
                top: offset.top + input.outerHeight(),
                left: offset.left
            });
        }
    });
});

$(document).on('click', function(e) {
    if (!$(e.target).closest('.suggestion-box, .item_code, .commodity').length) {
        $('.suggestion-box').remove();
    }
});
</script>
{% if lr.id %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('input, textarea').forEach(el => {
    const insideTable = el.closest('#tripTable'); 
    if (el.id === 'remarks') return;
    if (el.id === 'hamali') return;
    if (el.id === 'door_cl') return;
    if (el.id === 'risk_charge') return;
    if (el.id === 'statutory') return;
    if (el.id === 'cr_hamali') return;
    if (el.id === 'cr_door_cl') return;
    if (el.id === 'cr_risk_charge') return;
    if (el.id === 'cr_statutory') return;

    if (!insideTable && !['button', 'submit'].includes(el.type)) {
      el.setAttribute('readonly', true);
    }
  });
});
</script>
{% endif %}
<script>
function printInvoice() {

    const invoiceHTML = document.querySelector(".invoice-content").innerHTML;
    const win = window.open('', '', 'width=900,height=650');

    win.document.write(`
        <html>
        <head>
            <title>Invoice</title>
            <style>
                @page {
                    size: A4;
                    margin: 0;
                }

                body {
                    margin: 0;
                    padding: 0;
                    font-family: Arial, sans-serif;
                    -webkit-print-color-adjust: exact;
                }

                /* A4 Canvas */
                .page {
                    position: relative;
                    width: 210mm;
                    height: 297mm;
                }

                /* Quadrants */
                .quadrant {
                    position: absolute;
                    width: 105mm;
                    height: 148.5mm;
                    box-sizing: border-box;
                    padding: 6mm;
                    overflow: hidden;
                }

                /* Positions */
                .q1 { top: 0; left: 0; }          /* Client */
                .q2 { top: 0; left: 105mm; }      /* Customer */

                table {
                    width: 100%;
                    border-collapse: collapse;
                }

                th, td {
                    border: 1px solid black;
                    padding: 3px;
                    font-size: 9px;
                }
            </style>
        </head>

        <body>
            <div class="page">
                <!-- Copy 1 -->
                <div class="quadrant q1">
                    ${invoiceHTML}
                </div>

                <!-- Copy 2 -->
                <div class="quadrant q2">
                    ${invoiceHTML}
                </div>
            </div>
        </body>
        </html>
    `);

    win.document.close();
    win.focus();
    win.print();
    win.close();
}
</script>
{% if lr.id %}
<script>
    function confirmDelete() {
        Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "{% url 'main:cr_delete' cr_id=lr.id %}";
            }
        });
    }
</script>
{% endif %}


{% endblock %}
