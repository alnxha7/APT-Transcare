{% extends "base.html" %}
{% load static %}
{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorry Receipt</title>

    <link href="{% static 'css/font-face.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-4.7/css/font-awesome.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-5/css/fontawesome-all.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/mdi-font/css/material-design-iconic-font.min.css' %}" rel="stylesheet" media="all">

    <!-- Bootstrap CSS-->
    <link href="{% static 'vendor/bootstrap-4.1/bootstrap.min.css' %}" rel="stylesheet" media="all">

    <!-- Vendor CSS-->
    <link href="{% static 'vendor/animsition/animsition.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css' %}" rel="stylesheet"
          media="all">
    <link href="{% static 'vendor/wow/animate.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/css-hamburgers/hamburgers.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/slick/slick.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/select2/select2.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet" media="all">

    <!-- Main CSS-->
    <link href="{% static 'css/theme.css' %}" rel="stylesheet" media="all">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
        .form-control {
        padding: 0px 8px;
        font-size: 14px;
    }
    .mb-3, .mb-2 {
        margin-bottom: 8px !important;
        align-items: center;
    }
     body {
            font-family: Public Sans, sans-serif;
            background-color: #f4f4f4;

            margin: 0;
            padding: 0;
            font-size: 14px;
            align-items: center;
            color:black;
            overflow-x: hidden;

        }
         .logo p {
        color:white;
        }
        .container_box {
            background-color:#FEF3E2;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 2px solid rgb(43, 114, 227);
            margin-left:20px;
            margin-top: 25px;
        }


        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            padding-top: 7px;
            margin-bottom: 5px;
        }

        
        input, select {
            width: 100%;
            font-size: 10px;
        }
        select {
        background:white;
        

        }
        table {
            background:white;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom:20px;
        }
        .table_input{
            border:none;
        }
        th {
            border: 1px solid black;
            background:#f2f2f2;
            padding:0px;
            text-align: center;
            font-size: 12px;
        }
        button {
            padding: 10px;
            background: #28a745;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #218838;
        }
        .btn {
            margin-top: -10px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:20px;
        }

        .btn-info{
            margin-top: -25px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:-15px; 
        }

        .save-btn { background-color: #28a745; }
        .back-btn { background-color: #007bff; }

        .input-right {
            text-align: right;
        }
    @media only screen and (max-width: 600px) {
  .container_box  {
    width: 90%;
  }
}
    label {
        font-weight: 500;
        width: 90px;
        font-size: 12px;
    }
    .form-group-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .form-group-row label {
        min-width: 120px;
        margin-right: 8px;
        margin-bottom: 0;
    }
    /* .table-container {
            margin-top: 20px;
            overflow-x: auto;
        } */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th {
            border: 1px solid #999;
            padding: 0px;
            text-align: center;
        }
        td {
            border: 1px solid #999;
            padding: -4px;
            text-align: center;
            font-size: 11px;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"], input[type="number"] {
            /* width: 100%; */
            padding: -5px;
            box-sizing: border-box;
        }
        .btn-delete {
            color: white;
            border: none;
            padding: 0px 5px;
            cursor: pointer;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .table_data {
            font-size: 12px;
            padding: 2px 4px;
            text-align: center;
            width: 70px; /* set a fixed width */
            max-width: 80px; /* prevent stretching */
            box-sizing: border-box;
        }
.top-section {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 25px;
}

/* Column styling */
.column {
    flex: 1;
    min-width: 300px;
}

.column h4 {
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 10px;
    text-decoration: underline;
}

/* Single field row */
.form-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    width: 100%;
    gap: 8px;
}

.form-row label {
    flex: 0 0 68px;
    text-align: left;
    font-size: 13px;
    margin: 0;
    white-space: nowrap;
}

.form-row input,
.form-row select {
    flex: 1;
    padding: 2px 3px;
    font-size: 13px;
    border: 1px solid #ccc;
}

/* Double fields (2 per row) */
.form-row.double {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.field-pair {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 6px;
}

.field-pair label {
    flex: 0 0 3px;
    text-align: left;
    font-size: 13px;
}

.field-pair input,
.field-pair select {
    flex: 1.5;
}

/* Bottom OK button */
.bottom-buttons {
    width: 100%;
    text-align: center;
    margin-top: 12px;
}

.bottom-buttons button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 14px;
    font-size: 13px;
    border-radius: 4px;
    cursor: pointer;
}

.bottom-buttons button:hover {
    background-color: #0056b3;
}

/* Responsive */
@media (max-width: 992px) {
    .top-section {
        flex-direction: column;
    }
}

.form-group {
    margin: 0px;
}

    .bottom-section {
    display: flex;
    justify-content: space-between;
    gap: 20px;
}

.column {
    padding: 2px;
    border-radius: 6px;
   /* box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);*/
}

/* Widths to control layout */
/* .first-column {
    flex: 1; 
} */

.second-column {
    flex: 0.5; /* Center - less space */
    text-align: left;
}

.third-column {
    padding-left: 10px;
}

/* Optional: Ensure inputs are consistent */
.column input {
    width: 100%;
    font-size: 12px;
    margin-bottom: 0px;
}

/* Make labels a little smaller for alignment */
.column label {
    display: block;
    margin-bottom: 0px;
    font-size: 13px;
}
.d-flex.align-items-center {
    gap: 4px; /* Reduce space between label and input */
}

.d-flex.align-items-center > div {
    margin-bottom: 0;
    flex: 0 0 auto; /* Prevent stretching */
    padding-right: 4px; /* Small spacing */
}

.d-flex.align-items-center label {
    margin-bottom: 0;
    font-size: 12px; /* Optional: reduce font size */
    white-space: nowrap; /* Keep label on one line */
}

.d-flex.align-items-center input {
    flex: 1; /* Let input take remaining space */
    max-width: 150px; 
    font-size: 13px;
}
 </style>

<style>
.status-box {
    max-width: 450px;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    margin: 12px 0 18px;
    font-size: 13px;
    background: #ffffff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

/* Header */
.status-header {
    background: linear-gradient(90deg, #f7f7f7, #eeeeee);
    padding: 10px 12px;
    font-weight: 700;
    border-bottom: 1px solid #dcdcdc;
    border-radius: 8px 8px 0 0;
    letter-spacing: 0.3px;
}

/* Rows */
.status-row {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    padding: 10px 12px;
    border-bottom: 1px dashed #e2e2e2;
    align-items: center;
}

.status-row:last-child {
    border-bottom: none;
}

/* Left column */
.task {
    font-weight: 600;
    color: #333;
}

/* Right column */
.status {
    text-align: right;
    font-weight: 600;
}

/* Status pills */
.status.completed {
    color: #155724;
}

.status.pending {
    color: #856404;
}

/* Badge effect */
.status.completed::before,
.status.pending::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
}

.status.completed::before {
    background: #28a745;
}

.status.pending::before {
    background: #ffc107;
}

/* Document numbers */
.doc-no {
    display: block;
    font-size: 11.5px;
    color: #666;
    font-weight: normal;
    margin-top: 3px;
}
.lr-status-card {
    max-width: 480px;
    border-radius: 14px;
    background: #FEF3E2;
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    margin: 15px 0 25px;
    overflow: hidden;
    font-size: 13.5px;
    animation: fadeIn 0.4s ease-in-out;
}

/* Header */
.lr-status-header {
    padding: 14px 16px;
    font-weight: 700;
    font-size: 15px;
    color: #d88604;
    background: linear-gradient(135deg, #ffe797, #ffe797);
    letter-spacing: 0.4px;
}

/* Body */
.lr-status-body {
    padding: 10px 12px;
}

/* Row */
.lr-status-row {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    padding: 12px 10px;
    border-radius: 10px;
    margin-bottom: 8px;
    background: #f8f9fb;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.lr-status-row:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

/* Task */
.task {
    font-weight: 700;
    color: #2b2b2b;
}

/* Status Pill */
.status {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

/* Completed */
.status.completed {
    background: linear-gradient(135deg, #d88604, #d88604);
    color: #ffffff;
}

/* Pending */
.status.pending {
    background: linear-gradient(135deg, #f5ebc8, #f5ebc8);
    color: #000000b3;
}

/* Status dot */
.status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
}

/* Document number */
.doc-no {
    display: block;
    font-size: 11px;
    font-weight: 500;
    opacity: 0.9;
    margin-top: 4px;
    text-transform: none;
    color: white;
}

/* Animation */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(6px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

</style>
<!-- /* --------------------------- INVOICE STYLE ----------------------------- */ -->
<style>
#print-area { display: none; }

@media print {
  @page {
    size: A4 portrait;
    margin: 5mm; /* Minimal margins to maximize space */
  }

  body * { visibility: hidden; }

  #print-area, #print-area * { visibility: visible; }

  #print-area {
    display: flex;
    flex-direction: column;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%; /* Fill the whole A4 */
  }

  /* Each bill must be exactly 1/4th of the page */
  .lr-copy {
    height: 24.5%; 
    width: 100%;
    border-bottom: 1px dashed #000;
    overflow: hidden; /* Prevents content from spilling to next page */
    padding: 2px 0;
    box-sizing: border-box;
    display: block !important;
  }

  /* Reduce gaps that eat up space */
  .lr-copy div { margin-top: 2px !important; gap: 4px !important; }
  
  /* Scale the table for printing */
  table { margin-top: 4px !important; }
  
  #print-template { display: none; }
}
</style>

<!-- /* --------------------------- INVOICE STYLE END ----------------------------- */ -->

 <div class="container_box">

 <div class="container">


<h2>Lorry Receipt</h2>

<form method="post" id="bill-form">
    {% csrf_token %}
    <div class="container">
        <div class="top-section">
    <!-- 1?? Consigner Column -->
    <div class="column">
        <!-- Row 1: Series + Bill No -->
        <div class="form-row double" style="width: 154%;">
            <div class="field-pair">
                <label>Series</label>
                <select name="series" id="series" class="form-control" required style="padding: 3px 4px; font-size: 13px; height: 30px;" {% if lr.series %} disabled {% endif %}>
                        <option value="">Select Series</option>
                        {% for voucher in vouchers %}
                            <option value="{{ voucher.id }}" {% if lr.series.id == voucher.id %} selected {% endif %}>{{ voucher.series }}</option>
                        {% endfor %}
                    </select>
            </div>
            <div class="field-pair">
                <label>Lr No</label>
                <input type="text" name="entry_number" id="entry_number" class="form-control" value="{{ lr.lr_no }}" readonly required>
            </div>
            <div class="field-pair">
            <label>Date</label>
            <input type="date" id="bill_date" name="bill_date" 
            class="form-control" value="{% if lr.lr_date %}{{ lr.lr_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}" required>
        </div>
        </div>

        <!-- Row 2: Code + Name -->
        <div class="form-row double" style="width: 171%;">
            <div class="field-pair" style="max-width: 190px;">
                <label>Code</label>
                <input type="text" style="max-width: 50% !important;" id="consigner_code" name="consigner_code" class="form-control" value="{{ lr.consigner_code }}" readonly required>
            </div>
            <div class="field-pair" style="max-width: 335px; display: flex; align-items: center;">
                <label style="margin-right: 8px; white-space: nowrap;">Consignor Name</label>
                <input type="text" id="consigner_name" name="consigner_name" class="form-control" value="{{ lr.consigner_name }}" autocomplete="off" required>
            </div>
        </div>

        <!-- Row 3-5: Address 1-3 -->
        <div class="form-row"><label>Address 1</label><input type="text" id="consigner_address1" name="consigner_address1" class="form-control" value="{{ lr.consigner_account.address1 }}"></div>
        <div class="form-row"><label>Address 2</label><input type="text" id="consigner_address2" name="consigner_address2" class="form-control" value="{{ lr.consigner_account.address2 }}"></div>
        <div class="form-row"><label>Address 3</label><input type="text" id="consigner_address3" name="consigner_address3" class="form-control" value="{{ lr.consigner_account.address3 }}"></div>
        <div class="form-row"><label>GST No</label><input type="text" id="consigner_gstno" name="consigner_gstno" class="form-control" value="{{ lr.consigner_account.gstno }}"></div>
        <div class="form-row"><label>Phone</label><input type="text" id="consigner_phone" name="consigner_phone" class="form-control" value="{{ lr.consigner_account.mobile }}"></div>
    </div>

    <!-- 2?? Middle Column -->
    <div class="column" style="position: relative; top: 75px;">
        <div class="form-row">
            <label>E-Way Bill No</label>
            <input type="text" class="form-control" id="eway_billno" name="eway_billno" value="{{ lr.eway_billno|default_if_none:'' }}">
        </div>

        <div class="form-row">
            <label>Payment</label>
            <select id="payment_method" name="payment_method">
                <option value="PAID" {% if lr.payment == "PAID" %} selected {% endif %}>PAID</option>
                <option value="TO_PAY" {% if lr.payment == "TO_PAY" %} selected {% endif %}>TO PAY</option>
                <option value="CREDIT" {% if lr.payment == "CREDIT" %} selected {% endif %}>TBB</option>
            </select>
        </div>

        <div class="form-row">
            <label>Delivery Type</label>
            <select id="vehicle_no" name="vehicle_no" class="form-control" style="width:230px;height:25px;padding:0 4px;">
                <option value="">Select Delivery Type</option>
                <option value="GODOWN DELIVERY" {% if lr.vehicle_no == "GODOWN DELIVERY" %} selected {% endif %}>GODOWN DELIVERY</option>
                <option value="DOOR DELIVERY" {% if lr.vehicle_no == "DOOR DELIVERY" %} selected {% endif %}>DOOR DELIVERY</option>
            </select>
        </div>

        <div class="form-row">
            <label>Remarks</label>
            <input type="text" class="form-control" id="remarks" name="remarks" value="{{ lr.remarks }}">
        </div>
        <div class="form-row">
            <label>Invoice Amt</label>
            <input type="number" step="0.01" class="form-control" id="invoice_amount" name="invoice_amount" value="{{ lr.invoice_amount }}" required>
        </div>
        <input type="hidden" name="ajax_rate" step="0.01" id="ajax_rate">
    </div>

    <!-- 3?? Consignee Column -->
    <div class="column">
        <!-- Row 1: Code + Name -->
        <div class="form-row double" style="transform: translateX(-170px); width: 154%;">
            <div class="field-pair" style="max-width: 170px;">
                <label>Code</label>
                <input type="text" style="max-width: 50% !important;" id="consignee_code" name="consignee_code" value="{{ lr.consignee_code }}" class="form-control" readonly required>
            </div>
            <div class="field-pair" style="max-width: 300px; display: flex; align-items: center;">
                <label style="margin-right: 8px; white-space: nowrap;">Consignee Name</label>
                <input type="text" id="consignee_name" name="consignee_name" class="form-control" value="{{ lr.consignee_name }}" required>
            </div>
        </div>

        <!-- Row 2-4: Address 1-3 -->
        <div class="form-row"><label>Address 1</label><input type="text" name="consignee_address1" id="consignee_address1" class="form-control" value="{{ lr.consignee_account.address1 }}"></div>
        <div class="form-row"><label>Address 2</label><input type="text" name="consignee_address2" id="consignee_address2" class="form-control" value="{{ lr.consignee_account.address2 }}"></div>
        <div class="form-row"><label>Address 3</label><input type="text" name="consignee_address3" id="consignee_address3" class="form-control" value="{{ lr.consignee_account.address3 }}"></div>
        <div class="form-row"><label>GST No</label><input type="text" name="consignee_gstno" id="consignee_gstno" class="form-control" value="{{ lr.consignee_account.gstno }}"></div>
        <div class="form-row"><label>Phone</label><input type="text" name="consignee_phone" id="consignee_phone" class="form-control" value="{{ lr.consignee_phone }}" required></div>
        <div class="form-row"><label>Invoice No</label><input type="text" name="invoice_no" id="invoice_no" class="form-control" value="{{ lr.invoice_no }}" required></div>
        </div>
    </div>
</div>

        <!-- ?? Table Section -->
<div class="table-container">
        <table id="tripTable" border="1" style="width:100%; border-collapse:collapse; text-align:center;">
            <thead>
                <tr>
                    <th>Sl.no</th>
                    <th style="width: 6%;">Item Code</th>
                    <th style="width: 25%;">Commodity/Item</th>
                    <th>Pkg Type</th>
                    <th>Inv No</th>
                    <th style="width: 9%;">Inv Amt</th>
                    <th>Actual Weight</th>
                    <th style="width: 10%;">Charged Weight</th>
                    <th>Nos</th>
                    <th>Rate</th>
                    <th>Freight</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% if lr_items %}
                    {% for item in lr_items %}
                    <tr>
                        <td class="slno">{{ forloop.counter }}</td>
                        <td><input type="text" name="item_code[]" class="item_code form-control" value="{{ item.item_code }}"></td>
                        <td><input type="text" name="commodity[]" class="commodity form-control" value="{{ item.item }}"></td>
                        <td><input type="text" name="pkg[]" class="pkg form-control" value="{{ item.pkg }}"></td>
                        <td><input type="text" name="inv_no[]" class="inv_no form-control" value="{{ item.inv_no }}"></td>
                        <td><input type="number" name="inv_amount[]" class="inv_amount form-control" value="{{ item.inv_amount }}"></td>
                        <td><input type="number" name="weight[]" class="weight form-control" value="{{ item.weight }}"></td>
                        <td><input type="number" name="charged_weight[]" class="charged_weight form-control" value="{{ item.charged_weight }}"></td>
                        <td><input type="number" name="numbers[]" class="numbers form-control" value="{{ item.numbers }}"></td>
                        <td><input type="number" name="rate[]" class="rate form-control" step="0.01" value="{% if item.rate %}{{ item.rate }}{% else %}0{% endif %}"></td>
                        <td><input type="number" name="freight[]" class="freight form-control" value="{{ item.freight }}"></td>
                        <td><span class="delete-row" style="cursor:pointer; color:red;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="12" width="12" viewBox="0 0 640 640">
                                <path fill="#ff0000" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                            </svg>
                        </span></td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td class="slno">1</td>
                        <td><input type="text" name="item_code[]" class="item_code form-control"></td>
                        <td><input type="text" name="commodity[]" class="commodity form-control"></td>
                        <td><input type="text" name="pkg[]" class="pkg form-control"></td>
                        <td><input type="text" name="inv_no[]" class="inv_no form-control"></td>
                        <td><input type="number" name="inv_amount[]" class="inv_amount form-control"></td>
                        <td><input type="number" name="weight[]" class="weight form-control"></td>
                        <td><input type="number" name="charged_weight[]" class="charged_weight form-control"></td>
                        <td><input type="number" name="numbers[]" class="numbers form-control"></td>
                        <td><input type="number" name="rate[]" step="0.01" class="rate form-control" value="0"></td>
                        <td><input type="number" name="freight[]" class="freight form-control"></td>
                        <td><span class="delete-row" style="cursor:pointer; color:red;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="12" width="12" viewBox="0 0 640 640">
                                <path fill="#ff0000" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                            </svg>
                        </span></td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

        <!-- ?? Expense Details Section -->
        <div class="row mt-4"></div>

<div class="bottom-section"
     style="display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap;">

  <!-- LEFT COLUMN -->
  <div class="column" style="flex:1;min-width:250px;">
    <div class="d-flex align-items-center" style="margin-bottom:8px;">
      <label for="load_from" style="width:90px;">Load From</label>
      <select name="load_from" id="load_from"
              class="form-control"
              style="width:230px;height:25px;padding:0 4px;" required>
        <option value="">Select</option>
        {% for loc in locations %}
          <option value="{{ loc.location }}" {% if loc.location == lr.load_from %}selected{% endif %}>
            {{ loc.location }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="d-flex align-items-center" style="margin-bottom:8px;">
      <label for="load_to" style="width:90px;">Load To</label>
      <select name="load_to" id="load_to"
              class="form-control"
              style="width:230px;height:25px;padding:0 4px;" required>
        <option value="">Select</option>
        {% for loc in locations %}
          <option value="{{ loc.location }}" {% if loc.location == lr.load_to %}selected{% endif %}>
            {{ loc.location }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="d-flex align-items-center" style="margin-bottom:8px;">
      <label for="branch" style="width:90px;">Delivery Branch</label>
      <select name="branch" id="branch"
              class="form-control"
              style="width:230px;height:25px;padding:0 4px;" required>
        <option value="">Select</option>
        {% for bra in branches %}
          <option value="{{ bra.branch_name }}" {% if bra.branch_name == lr.branch_to %}selected{% endif %}>
            {{ bra.branch_name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>



  <!-- CENTER COLUMN (NEW FIELDS) -->
  <div class="center-column" style="flex:1;min-width:250px;">

    <div class="d-flex align-items-center" style="margin-bottom:8px;">
      <label for="hamali" style="width:120px;">Hamali</label>
      <input type="number" class="form-control"
             name="hamali" id="hamali"
             value="{{ lr.hamali|default:'0.00' }}"
             step="0.01"
             style="width:130px;height:25px;">
    </div>

    <div class="d-flex align-items-center" style="margin-bottom:8px;">
      <label for="door_cl" style="width:120px;">Door CL/DL</label>
      <input type="number" class="form-control"
             name="door_cl" id="door_cl"
             value="{{ lr.door_cl_dl|default:'0.00' }}"
             step="0.01"
             style="width:130px;height:25px;">
    </div>

    <div class="d-flex align-items-center" style="margin-bottom:8px;">
      <label for="risk_charge" style="width:120px;">Risk Charge</label>
      <input type="number" class="form-control"
             name="risk_charge" id="risk_charge"
             value="{{ lr.risk_charge|default:'0.00' }}"
             step="0.01"
             style="width:130px;height:25px;">
    </div>

    <div class="d-flex align-items-center">
      <label for="statutory" style="width:120px;">Stationary Charge</label>
      <input type="number" class="form-control"
             name="statutory" id="statutory"
             value="{{ lr.statutory_charge|default:'0.00' }}"
             step="0.01"
             style="width:130px;height:25px;">
    </div>

  </div>



  <!-- RIGHT COLUMN (TOTALS) -->
   
  <div class="totals-column" style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;min-width:220px;">

    <div style="display:flex;align-items:center;gap:10px;">
    <label for="gross_amount" style="width:110px;text-align:right;">Gross Amount</label>
    <input type="number" class="form-control"
            name="gross_amount" id="gross_amount"
            value="{{ lr.gross_amount|default:'0.00' }}"
            step="0.01"
            style="width:100px;height:25px;text-align:right;" readonly>
    </div>

    <div style="display:flex;align-items:center;gap:10px;">
      <label for="total_charges" style="width:110px;text-align:right;">Total Charges</label>
      <input type="number" class="form-control"
             name="total_charges" id="total_charges"
             value="{{ lr.total_charges|default:'0.00' }}"
             step="0.01"
             style="width:100px;height:25px;text-align:right;" readonly>
    </div>

    <div style="display:flex;align-items:center;gap:10px;">
      <label for="grand_total" style="width:110px;text-align:right;">Grand Total</label>
      <input type="number" class="form-control"
             name="grand_total" id="grand_total"
             value="{{ lr.grand_total|default:'0.00' }}"
             step="0.01"
             style="width:100px;height:25px;text-align:right;background-color: green;color: white; font-size: 14px;padding: 0px;" readonly>
    </div>
  </div>

</div>

{% if not request.GET.action == 'check_status' %}
<!-- ?? Buttons Section -->
<div class="text-end" style="margin-top:0px;">
{% if request.GET.action == 'delete' %}
    <a href="{% url 'main:index' %}" class="btn btn-primary btn-sm">Cancel</a>
    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
{% else %} 
  <a href="{% url 'main:index' %}" class="btn btn-danger btn-sm">Cancel</a>
  <button type="submit" class="btn btn-primary btn-sm print-button" name="action" value="print">Print</button>
  <button type="submit" class="btn btn-success btn-sm" name="action" value="save">Save</button>
{% endif %}
</div>
{% endif %}
</form>



{% if request.GET.action == 'check_status' %}
<div class="lr-status-card">
    <div class="lr-status-header">
         LR Status Tracker
    </div>

    <div class="lr-status-body">

        <div class="lr-status-row">
            <div class="task">GDM</div>
            <div class="status {% if request.GET.gdm == '1' %}completed{% else %}pending{% endif %}">
                {% if request.GET.gdm == '1' %}
                    Completed
                    {% if request.GET.gdm_no %}
                        <span class="doc-no">GDM No: {{ request.GET.gdm_no }}</span>
                    {% endif %}
                {% else %}
                    Pending
                {% endif %}
            </div>
        </div>

        <div class="lr-status-row">
            <div class="task">Received</div>
            <div class="status {% if request.GET.received == '1' %}completed{% else %}pending{% endif %}">
                {% if request.GET.received == '1' %}Received{% else %}Pending{% endif %}
            </div>
        </div>

        <div class="lr-status-row">
            <div class="task">Delivery</div>
            <div class="status {% if request.GET.delivery == '1' %}completed{% else %}pending{% endif %}">
                {% if request.GET.delivery == '1' %}
                    Delivered
                    {% if request.GET.cash_no %}
                        <span class="doc-no">Receipt: {{ request.GET.series }}{{ request.GET.cash_no }}</span>
                        {% if request.GET.delivery_date %}
                            <span class="doc-no">Date: {{ request.GET.delivery_date }}</span>
                        {% endif %}
                    {% endif %}
                {% else %}
                    Pending
                {% endif %}
            </div>
        </div>

    </div>
</div>
{% endif %}


</div>
</div>



<!-- --------------------------------------------- INVOICE PRINT TEMPLATE -------------------------------------------------- -->

<div id="print-area">
  <div id="print-template" style="height: 24.5%; overflow: hidden; border-bottom: 1px dashed #000; padding: 2px 0; margin-bottom: 2px;">
    
    <div style="display:flex; width:100%; align-items: center;">
      <div style="flex:1;">
        <img src="{% static 'images/icon/apt_logo.png' %}" style="width:60px; height:auto;">
      </div>

      <div style="flex:2; text-align:center;">
        <div style="font-size:4px; font-weight:600;">Goods consignment at owner's risk - Coimbatore jurisdiction</div>
        <div style="font-size:15px; font-weight:800; text-transform:uppercase; line-height:1;">
          {{ lr.company.companyname }}
        </div>
        <div style="font-size:7px; font-weight:600;">Goods and Transport Agency</div>
        <div style="font-size:6.5px; line-height:1.2;">
          {{ lr.company.address1 }}, {{ lr.company.address2 }}, {{ lr.company.address3 }}<br>
          Mob: {{ lr.company.phoneno }}, {{ lr.company.mobile }}
        </div>
      </div>

      <div style="flex:1; display:flex; justify-content:flex-end;">
        <div style="border:1px solid #000; padding:2px 5px; width:110px; font-size:7px;">
          <strong>Booking Office:</strong><br>{{ lr.branch.branch_name }}
        </div>
      </div>
    </div>

    <div style="display:flex; width:100%; margin-top:4px; gap:5px;">
      <div style="flex:1.5;">
        <div style="font-size:8px; font-weight:700; margin-bottom:2px;">GST: {{ lr.company.gst }}</div>
        <div style="font-size:7px; font-weight:700; margin-bottom:2px;">E-Way: {% if lr.eway_billno %}{{ lr.eway_billno }}{% else %}Not Applicable{% endif %}</div>
        <div style="display:flex; gap:4px; margin-bottom:4px;">
          <div style="flex:1; border:1px solid #000; padding:3px; font-size:6.5px;">
            <strong>Consignee Copy</strong><br>
            <input type="checkbox" style="transform: scale(0.7);"> Insured 
            <input type="checkbox" style="transform: scale(0.7);"> Not Insured
          </div>
          <div style="flex:1; border:1px solid #000; padding:3px; font-size:6.5px;">
            <strong>Inv/Tax No:</strong><br>{{ lr.invoice_no }}
          </div>
          <div style="flex:1; border:1px solid #000; padding:3px; font-size:6.5px;">
            <strong>Destination Branch:</strong><br>{{ lr.branch_to }}
          </div>
        </div>
        <div style="font-size:7px; line-height:1.2;">
          <strong>Consignor:</strong> {{ lr.consigner_name }} | <strong>GST:</strong> {{ lr.consigner_account.gstno }}
           | <strong>Place:</strong> {{ lr.consigner_account.address1 }} | <strong>Phone:</strong> {{ lr.consigner_account.mobile }}<br>

          <strong>Consignee:</strong> {{ lr.consignee_name }} | <strong>GST:</strong> {{ lr.consignee_account.gstno }}
          | <strong>Place:</strong> {{ lr.consignee_account.address1 }} | <strong>Phone:</strong> {{ lr.consignee_phone }}
        </div>
      </div>

      <div style="flex:1;">
        <div style="border:1px solid #000; padding:3px; font-size:7px; margin-bottom:2px;">
          <strong><p style="margin: 0px; font-size: 9px;">LR No:  {{ lr.series.series }}{{ lr.lr_no }}</strong></p> <strong>Date:</strong> {{ lr.lr_date }}<br>
          <strong>From:</strong> {{ lr.load_from }} | <strong>To:</strong> {{ lr.load_to }}
        </div>
        <div style="border:1px solid #000; padding:2px; font-size:6px; text-align:center;">
          <strong>RCM Liability (5%)</strong>
          <div style="display:flex; justify-content: space-around; margin-top:1px;">
            <span><input type="checkbox" style="transform: scale(0.6);"> Consignor</span>
            <span><input type="checkbox" style="transform: scale(0.6);"> Consignee</span>
          </div>
        </div>
      </div>
    </div>

    <table border="1" style="width:100%; border-collapse:collapse; margin-top:5px; font-size:6.5px; text-align:center;">
  <thead>
    <tr style="background:#f2f2f2; font-weight:bold;">
      <th style="width:5%;">Sl</th>
      <th style="width:35%;">Item</th>
      <th style="width:10%;">Inv.Amt</th>
      <th style="width:10%;">Wt</th>
      <th style="width:10%;">Ch.Wt</th>
      <th style="width:8%;">Nos</th>
      <th style="width:12%;">Freight</th>
    </tr>
  </thead>
  <tbody>
    {% if lr_items %}
      {% for item in lr_items|slice:":3" %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td style="text-align:left; padding-left:2px;">{{ item.item }}</td>
        <td>{{ item.inv_amount }}</td>
        <td>{{ item.weight }}</td>
        <td>{{ item.charged_weight }}</td>
        <td>{{ item.numbers }}</td>
        <td>{{ item.freight }}</td>
      </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>

<div style="display:flex; width:100%; margin-top:3px; border-top: 1px solid #000; padding-top:2px;">
  
  <div style="flex:1.5; font-size:6px; line-height:1.2; padding-right:10px;">
    <strong>Declaration:</strong><br>
    1. Carrier not responsible for breakage/leakage.<br>
    2. Goods accepted as per terms overleaf.
    <div style="margin-top:10px; font-weight:bold;">Receiver's Signature</div>
  </div>

  <div style="flex:1; font-size:7px; line-height:1.3; border-left: 1px solid #000; padding-left:8px;">
    <div style="display:flex; justify-content:space-between;"><span>Gross Amt</span><span>{{ lr.gross_amount|default:'0.00' }}</span></div>
    <div style="display:flex; justify-content:space-between;"><span>Hamali</span><span>{{ lr.hamali|default:'0.00' }}</span></div>
    <div style="display:flex; justify-content:space-between;"><span>Door CL/DL</span><span>{{ lr.door_cl_dl|default:'0.00' }}</span></div>
    <div style="display:flex; justify-content:space-between;"><span>Risk Chg</span><span>{{ lr.risk_charge|default:'0.00' }}</span></div>
    <div style="display:flex; justify-content:space-between;"><span>Stationary</span><span>{{ lr.statutory_charge|default:'0.00' }}</span></div>
    
    <div style="display:flex; justify-content:space-between; font-weight:bold; border-top:1px solid #000; margin-top:2px; padding-top:1px;">
      <span style="font-size:9px;">GRAND TOTAL</span>
      <span style="font-size:9px;">{{ lr.grand_total|default:'0.00' }}</span>
    </div>
  </div>
</div>

  </div>
</div>


<!-- --------------------------------------------- INVOICE PRINT TEMPLATE -------------------------------------------------- -->





<script src="{% static 'vendor/jquery-3.2.1.min.js' %}"></script>
<!-- Then jQuery UI -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<!-- Then jQuery UI -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<!-- Bootstrap JS-->
<script src="{% static 'vendor/bootstrap-4.1/popper.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-4.1/bootstrap.min.js' %}"></script>
<!-- Vendor JS       -->
<script src="{% static 'vendor/slick/slick.min.js' %}">
</script>
<script src="{% static 'vendor/wow/wow.min.js' %}"></script>
<script src="{% static 'vendor/animsition/animsition.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar.min.js' %}">
</script>
<script src="{% static 'vendor/counter-up/jquery.waypoints.min.js' %}"></script>
<script src="{% static 'vendor/counter-up/jquery.counterup.min.js' %}">
</script>
<script src="{% static 'vendor/circle-progress/circle-progress.min.js' %}"></script>
<script src="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.js' %}"></script>
<script src="{% static 'vendor/chartjs/Chart.bundle.min.js' %}"></script>
<script src="{% static 'vendor/select2/select2.min.js' %}">
</script>

<!-- Main JS-->
<script src="{% static 'js/main.js' %}"></script>

{% if print %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'LR Saved Successfully',
        confirmButtonText: 'Print Invoice'
    }).then((result) => {
        if (result.isConfirmed) {
            printInvoice();  
            window.location.href = "{% url 'main:lorry_receipt' %}"
        }
        else {
            window.location.href = "{% url 'main:lorry_receipt' %}"
        }
    });
</script>
{% elif success and lr.id %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'LR Saved Successfully',
        confirmButtonText: 'OK',
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'main:lr_search' %}"
        }
        else {
            window.location.href = "{% url 'main:lr_search' %}"
        }
    });
</script>
{% elif success %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'LR Saved Successfully',
        confirmButtonText: 'OK',
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'main:lorry_receipt' %}"
        }
        else {
            window.location.href = "{% url 'main:lorry_receipt' %}"
        }
    });
</script>
{% elif error %}
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Error Saving the LR....Please Try Again.....!!! {{error|escapejs}}',
        confirmButtonText: 'OK'
    });
</script>
{% endif %}
<script>
    document.getElementById('series').addEventListener('change', function () {
        const seriesId = this.value;
        if (seriesId) {
            fetch(`/get_serial_number_lr/?series_id=${seriesId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.serial_no !== undefined) {
                        $('input[name="entry_number"]').val(data.serial_no);
                    } else {
                        document.getElementById('entry_number').value = '';
                    }
                })
                .catch(error => {
                    console.error('Error fetching serial number:', error);
                    document.getElementById('entry_number').value = '';
                });
        } else {
            document.getElementById('entry_number').value = '';
        }
    });
</script>
<script>
    $(document).ready(function() {
        $('#consigner_name, #consignee_name').select2({
            allowClear: true,
            width: 'style'
        });
    });
</script>
<script>
function setupAutocomplete(prefix) {
    $(`#${prefix}_name`).autocomplete({
        source: '/ajax/autocomplete-customers/', 
        minLength: 1,
        select: function(event, ui) {
            $(`#${prefix}_name`).val(ui.item.value);
            $(`#${prefix}_address1`).val(ui.item.address || '');
            $(`#${prefix}_address2`).val(ui.item.address2 || '');
            $(`#${prefix}_address3`).val(ui.item.address3 || '');
            $(`#${prefix}_gstno`).val(ui.item.gstno || '');
            $(`#${prefix}_phone`).val(ui.item.mobile || '');
            $(`#${prefix}_code`).val(ui.item.account_code || '');
            return false;
        }
    });
}

$(document).ready(function() {
    setupAutocomplete("consigner");
    setupAutocomplete("consignee");
});
</script>

<script>
function updateTotals() {
    let freight_total = 0;

    // Calculate total freight from table
    $("#tripTable tbody tr").each(function() {
        const freight = parseFloat($(this).find(".freight").val()) || 0;
        freight_total += freight;
    });

    // Set Gross Amount (only freight)
    $("#gross_amount").val(freight_total.toFixed(2));

    // Get additional charges
    let hamali = parseFloat($("#hamali").val()) || 0;
    let door_cl = parseFloat($("#door_cl").val()) || 0;
    let risk_charge = parseFloat($("#risk_charge").val()) || 0;
    let statutory = parseFloat($("#statutory").val()) || 0;

    // Total Charges = Freight + Extra charges
    let total_charges = freight_total + hamali + door_cl + risk_charge + statutory;

    // Grand Total (same for now)
    let grand_total = total_charges;

    $("#total_charges").val(total_charges.toFixed(2));
    $("#grand_total").val(grand_total.toFixed(2));
    toggleEwayBill();
}

$(document).on("input", ".freight", function () {
    if (this.value < 0) this.value = 0;
    updateTotals();
});


$(document).on("input", "#hamali, #door_cl, #risk_charge, #statutory", function () {
    updateTotals();
});
$(document).ready(function() {

    // ?? Function to calculate total freight and update totals

    // ?? Function to add new row
    function addNewRow() {
    const table = $("#tripTable tbody");
    const rowCount = table.find("tr").length + 1;

    const newRow = `
        <tr>
            <td class="slno">${rowCount}</td>
            <td><input type="text" name="item_code[]" class="item_code form-control"></td>
            <td><input type="text" name="commodity[]" class="commodity form-control"></td>
            <td><input type="text" name="pkg[]" class="pkg form-control"></td>
            <td><input type="text" name="inv_no[]" class="inv_no form-control"></td>
            <td><input type="number" name="inv_amount[]" class="inv_amount form-control"></td>
            <td><input type="number" name="weight[]" class="weight form-control"></td>
            <td><input type="number" name="charged_weight[]" class="charged_weight form-control"></td>
            <td><input type="number" name="numbers[]" class="numbers form-control"></td>

            <!-- ?? auto-apply rate when creating row -->
            <td><input type="number" name="rate[]" class="rate form-control" value="0"></td>

            <td><input type="number" name="freight[]" class="freight form-control"></td>
            <td><span class="delete-row" style="cursor:pointer; color:red;">
                <svg xmlns="http://www.w3.org/2000/svg" height="12" width="12" viewBox="0 0 640 640">
                    <path fill="#ff0000" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                </svg>
            </span></td>
        </tr>`;

    table.append(newRow);
    updateSerialNumbers();
    updateTotals();
}


    // ?? Update serial numbers after add/remove
    function updateSerialNumbers() {
        $("#tripTable tbody tr").each(function(index) {
            $(this).find(".slno").text(index + 1);
        });
    }

    // ?? Delete a row
    $(document).on("click", ".delete-row", function() {
        const rowCount = $("#tripTable tbody tr").length;
        if (rowCount <= 1) {
            Swal.fire({
                icon: "warning",
                title: "At least one row must remain!",
                confirmButtonColor: "#d33",
                confirmButtonText: "OK"
            });
            return;
        }
        $(this).closest("tr").remove();
        updateSerialNumbers();
        updateTotals(); // ?? Update totals after deleting a row
    });

    // ?? Add row on Enter key in rate/freight fields
    $(document).on("keydown", ".rate, .freight", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            addNewRow();
        }
    });

    // ?? Add new row on table double-click
    $("#tripTable").on("dblclick", function() {
        addNewRow();
    });

});
</script>

<script>
$(document).on('input', '.item_code, .commodity', function() {
    let input = $(this);
    let query = input.val().trim();
    let row = input.closest('tr');

    $('.suggestion-box').remove();
    if (query.length < 1) return; 
    $.ajax({
        url: '/ajax/item-search/',
        data: { q: query },
        dataType: 'json',
        success: function(data) {
            $('.suggestion-box').remove();

            if (data.length === 0) return;
            let suggestionBox = $('<div class="suggestion-box"></div>');
            suggestionBox.css({
                position: 'absolute',
                background: '#fff',
                border: '1px solid #ccc',
                'z-index': 1000,
                'max-height': '150px',
                'overflow-y': 'auto',
                width: input.outerWidth()
            });

            $.each(data, function(i, item) {
                let option = $('<div class="suggestion-item"></div>').text(item.name);
                option.css({ padding: '0px', cursor: 'pointer', fontSize: '12px', borderBottom: '1px solid #7b7878' });

                option.on('click', function() {
                    row.find('.commodity').val(item.name);
                    row.find('.item_code').val(item.item_code);
                    $('.suggestion-box').remove();
                });

                suggestionBox.append(option);
            });

            $('body').append(suggestionBox);

            let offset = input.offset();
            suggestionBox.css({
                top: offset.top + input.outerHeight(),
                left: offset.left
            });
        }
    });
});

$(document).on('click', function(e) {
    if (!$(e.target).closest('.suggestion-box, .item_code, .commodity').length) {
        $('.suggestion-box').remove();
    }
});
</script>
{% if lr.id %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('input, textarea').forEach(el => {
    const insideTable = el.closest('#tripTable'); 
    if (el.id === 'remarks') return;
    if (el.id === 'eway_billno') return;
    if (el.id === 'hamali') return;
    if (el.id === 'door_cl') return;
    if (el.id === 'risk_charge') return;
    if (el.id === 'statutory') return;

    if (!insideTable && !['button', 'submit'].includes(el.type)) {
      el.setAttribute('readonly', true);
    }
  });
});
</script>
{% endif %}
<script>
function printInvoice() {
    const template = document.getElementById("print-template").innerHTML;
    
    // Create the 4 copies string
    let fullContent = "";
    for (let i = 1; i <= 4; i++) {
        fullContent += `<div class="lr-copy">${template}</div>`;
    }

    // Create a new temporary window/iframe
    const printWindow = window.open('', '_blank', 'height=600,width=800');

    printWindow.document.write('<html><head><title>Print Invoice</title>');
    
    // Add the CSS specifically for the print window
    printWindow.document.write(`
        <style>
            body { font-family: sans-serif; margin: 0; padding: 0; }
            .lr-copy { 
                width: 100%; 
                padding: 1mm; 
                box-sizing: border-box;
                border-bottom: 1px dashed #000; 
                page-break-inside: avoid;
            }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid black; padding: 5px; text-align: center; }
            /* Force images to load */
            img { width: 140px; height: auto; }
        </style>
    `);
    
    printWindow.document.write('</head><body>');
    printWindow.document.write(fullContent);
    printWindow.document.write('</body></html>');

    printWindow.document.close();

    // Wait for images/styles to load then print
    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    };
}
</script>
{% if lr.id %}
<script>
    function confirmDelete() {
        Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "{% url 'main:lr_delete' lr_id=lr.id %}";
            }
        });
    }
</script>
{% endif %}

<script>
function toggleEwayBill() {
    const grandTotal = parseFloat($("#invoice_amount").val()) || 0;

    if (grandTotal >= 50000) {
        $("#eway_billno").prop("required", true);
    } else {
        $("#eway_billno").prop("required", false).val("");
    }
}

// Run once on page load
$(document).ready(function () {
    toggleEwayBill();
});
</script>

{% if request.GET.action == 'check_status' %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('input, textarea').forEach(el => {
            
            if (!['button', 'submit'].includes(el.type)) {
                el.setAttribute('readonly', true);
            }
        });
        document.querySelectorAll('select').forEach(el => {
            el.disabled = true;
        });
    });
</script>
{% endif %}
<script>
document.addEventListener('input', function (e) {
    if (e.target.classList.contains('inv_no')) {

        // Get first row inv_no only
        const firstInvNoInput = document.querySelector('#tripTable tbody tr:first-child .inv_no');

        // If the edited field IS the first row
        if (e.target === firstInvNoInput) {
            document.getElementById('invoice_no').value = e.target.value;
        }
    }
});
</script>
<script>
function calculateInvoiceAmount() {
    let total = 0;
    document.querySelectorAll('.inv_amount').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('invoice_amount').value = total.toFixed(2);
}

// Listen for changes
document.addEventListener('input', function (e) {
    if (e.target.classList.contains('inv_amount')) {
        calculateInvoiceAmount();
    }
});

// Initial calculation (for edit page)
calculateInvoiceAmount();
</script>

{% endblock %}
